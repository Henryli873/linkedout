{% extends 'base.html' %}

{% block title %}Find Applicants{% endblock %}

{% extends 'base.html' %}

{% block extra_css %}
<style>
.search-container {
  position: relative;
}

.autocomplete-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.autocomplete-item:hover {
  background-color: #f8f9fa;
}

.autocomplete-item.selected {
  background-color: #007bff;
  color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2>Find Applicants</h2>
    <div class="text-muted small">{{ profiles|length }} results</div>
  </div>

  <div class="card mt-3">
    <div class="card-body">
      <form method="get" class="row gx-2 gy-2 align-items-end">
        <div class="col-auto">
          <label class="form-label small">Query</label>
          <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="keywords">
        </div>
        <div class="col-auto">
          <label class="form-label small">Skills</label>
          <input type="text" name="skills" value="{{ skills }}" class="form-control form-control-sm" placeholder="e.g. Python, Django">
        </div>
        <div class="col-auto">
          <label class="form-label small">Location</label>
          <div class="search-container">
            <input type="text" name="location" value="{{ location }}" class="form-control form-control-sm" placeholder="City, State or address" autocomplete="off">
            <div class="autocomplete-dropdown"></div>
          </div>
        </div>
        <div class="col-auto">
          <label class="form-label small">Experience</label>
          <input type="text" name="experience" value="{{ experience }}" class="form-control form-control-sm" placeholder="e.g. 3 years, internship">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary btn-sm">Search</button>
        </div>
      </form>
      <div class="form-text mt-1">Tip: separate multiple skills with commas.</div>
    </div>
  </div>

  {% if profiles %}
    <div class="row gy-3 mt-3">
      {% for p in profiles %}
        <div class="col-12">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1">{{ p.user.get_full_name|default:p.user.username }}</h5>
                {% if p.headline_visible and p.headline %}
                  <div class="text-muted small">{{ p.headline }}</div>
                {% endif %}
                <div class="mt-2">
                  {% if p.skills_visible and p.skills %}
                    <div><strong>Skills:</strong> {{ p.skills }}</div>
                  {% endif %}
                  {% if p.experience_visible and p.experience %}
                    <div class="mt-1"><strong>Experience:</strong> {{ p.experience|truncatechars:160 }}</div>
                  {% endif %}
                  {% if p.education_visible and p.education %}
                    <div class="mt-1"><strong>Education:</strong> {{ p.education|truncatechars:120 }}</div>
                  {% endif %}
                  {% if p.location %}
                    <div class="mt-1 text-muted small">{{ p.location }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="ms-3 d-flex flex-column align-items-end">
                <a href="{% url 'accounts:profile_detail' p.user.username %}" class="btn btn-outline-primary btn-sm mb-2">View Profile</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted mt-3">No applicants found matching your filters.</p>
  {% endif %}

  <div class="mt-4">
    <a href="/" class="btn btn-secondary">Back home</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// MapBox API functions
async function searchAddresses(query, limit = 5) {
  if (query.length < 3) return [];
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiaGFpaGxlIiwiYSI6ImNtZnZkZWF0azA2YmkyeXBqOW15MnpyYmsifQ._VgiLAueIm7KWmZLY5hGTQ';
  
  if (!MAPBOX_TOKEN || MAPBOX_TOKEN === 'YOUR_MAPBOX_TOKEN') return [];
  
  try {
    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&limit=${limit}&autocomplete=true`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.features) {
      return data.features.map(item => ({
        display_name: item.place_name,
        lat: item.center[1],
        lon: item.center[0]
      }));
    }
    return [];
  } catch (error) { return []; }
}

// Autocomplete for location input
const locationInput = document.querySelector('input[name="location"]');
const dropdown = document.querySelector('.autocomplete-dropdown');
let searchTimeout;

if (locationInput && dropdown) {
  locationInput.addEventListener('input', async function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    
    if (query.length < 3) {
      dropdown.style.display = 'none';
      return;
    }
    
    searchTimeout = setTimeout(async () => {
      const suggestions = await searchAddresses(query);
      
      dropdown.innerHTML = '';
      if (suggestions.length > 0) {
        suggestions.forEach(suggestion => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = suggestion.display_name;
          item.addEventListener('click', () => selectSuggestion(suggestion));
          dropdown.appendChild(item);
        });
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }, 300);
  });
  
  locationInput.addEventListener('blur', function() {
    setTimeout(() => dropdown.style.display = 'none', 150);
  });
  
  locationInput.addEventListener('focus', function() {
    if (dropdown.children.length > 0) {
      dropdown.style.display = 'block';
    }
  });
}

function selectSuggestion(suggestion) {
  locationInput.value = suggestion.display_name;
  dropdown.style.display = 'none';
}
</script>
{% endblock %}